<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>6</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
          rel="stylesheet">

    <style>

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --text: #0d1918;
            --background: #d0e1e1;
            --primary: #68afa8;
            --secondary: #cb9db8;
            --accent: #c19589;


            --shadow: rgba(0, 0, 0, 0.15) 1.95px 1.95px 2.6px;
        }

        html {
            font-family: "Poppins", "serif";
            box-sizing: border-box;

        }

        *::-webkit-scrollbar {
            width: 6px;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 5px;
        }

        *::-webkit-scrollbar-track {
            background-color: #f1f1f1;
            border-radius: 5px;
        }

        button {
            border: none;
            outline: none;
            font-family: "Poppins", "serif";
            box-shadow: var(--shadow);
            transition: all 200ms ease;
            cursor: pointer;
        }

        button:hover {
            transform: scale(101%);
        }

        button:active {
            transform: scale(98%);
        }

        #network-simulation-app {
            display: grid;
            grid-template-rows: 1fr 1fr;
            min-height: 150vh;
            gap: 1rem;
            background-color: var(--background);
            padding: 0.5rem;
        }

        .main-container {
            display: grid;
            grid-template-columns: 6fr 1fr 3fr;
            gap: 1rem;
        }

        .entering-interface-container {
            display: flex;
            align-items: center;
        }

        .entering-interface-container .interface-queue {
            justify-content: flex-end;
        }

        .existing-interfaces-container {
            display: grid;
            grid-template-rows: 1fr 1fr 1fr;
            justify-content: center;
            flex-direction: column;
            /*align-items: center;*/
            gap: 0.3rem;
        }

        .interface {
            display: grid;
            gap: 1rem;
            grid-template-columns: 7fr 0.5fr;
            background-color: var(--primary);
            border-radius: 5px;
            padding: 0.5rem;
            font-size: 0.5rem;
            width: 100%;
            box-shadow: var(--shadow);
        }

        .exit-interface {
            grid-template-columns: 1fr 6fr;
        }


        .interface-queue {
            display: flex;
            gap: 0.5rem;
        }

        .exit-interface .interface-queue {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .interface-info-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: var(--secondary);
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: var(--shadow);
        }

        .interface-info > div:first-child {
            border-radius: 30px;
        }

        .interface-info-filed {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .datagram {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
            padding: 0.1rem 0.3rem;
            background-color: var(--accent);
            border-radius: 5px;
            box-shadow: var(--shadow);
        }

        .datagram-field {
            display: flex;
            gap: 0.5rem;
        }

        .router-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .router {
            font-size: 5rem;
            width: 90%;
            aspect-ratio: 1/1;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 5px var(--accent) solid;
            border-radius: 50%;
            box-shadow: var(--shadow);
            background-color: var(--primary);
            color: white;
        }

        #router-hostname {
            font-size: 1.5rem;
        }

        #simulate-routing-btn {
            padding: 1rem;
            border-radius: 10px;
            background-color: var(--secondary);
            color: white;
            font-weight: 500;
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            font-size: 0.7rem;
            gap: 0.5rem;
        }

        .discarded-datagrams-table {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: var(--secondary);
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: var(--shadow);
        }

        .discarded-datagrams {
            display: flex;
            padding: 0.5rem;
            flex-wrap: wrap;
        }

        .routing-table-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: var(--primary);
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: var(--shadow);
        }

        .routing-table {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .routing-table-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
        }

        .routing-table-entry {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            background-color: var(--secondary);
            padding: 0.3rem;
            box-shadow: var(--shadow);
            border-radius: 5px;
        }

        .arp-table-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: var(--accent);
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: var(--shadow);

        }

        .arp-table {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .arp-table-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .arp-table-entry {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-radius: 5px;
            padding: 0.3rem;
            background-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .frame-field {
            display: flex;
            gap: 0.2rem;
            justify-content: center;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            background-color: var(--primary);
        }


    </style>
</head>
<body>

<div id="network-simulation-app">
    <main class="main-container">
        <div class="entering-interface-container">
            <div class="interface">
                <div class="interface-queue" id="entering-interface-queue">
                </div>
                <div class="interface-info-container">
                    <div class="interface-info">
                        <div class="interface-info-filed" style="background-color: red;">&nbsp;</div>
                        <div class="interface-info-filed">
                            <h3>Interface:</h3>
                            <div class="interface-id" id="entering-interface-name"></div>
                        </div>
                        <div class="interface-info-filed">
                            <h3>IP:</h3>
                            <div class="interface-ip" id="entering-interface-ip"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="router-container">
            <div class="router">
                X
            </div>
            <div id="router-hostname">
                Router A
            </div>
            <button id="simulate-routing-btn">
                Simulate Routing
            </button>
        </div>
        <div class="existing-interfaces-container">
            <div class="interface exit-interface">
                <div class="interface-info-container">
                    <div class="interface-info">
                        <div class="interface-info-filed" style="background-color: blue;">&nbsp;</div>
                        <div class="interface-info-filed">
                            <h3>Interface:</h3>
                            <div class="interface-id" id="exit-interface-0-name"></div>
                        </div>
                        <div class="interface-info-filed">
                            <h3>IP:</h3>
                            <div class="interface-ip" id="exit-interface-0-ip"></div>
                        </div>
                    </div>

                </div>
                <div class="interface-queue" id="exit-interface-0">

                </div>
            </div>
            <div class="interface exit-interface">
                <div class="interface-info-container">
                    <div class="interface-info">
                        <div class="interface-info-filed" style="background-color: yellow;">&nbsp;</div>
                        <div class="interface-info-filed">
                            <h3>Interface:</h3>
                            <div class="interface-id" id="exit-interface-1-name"></div>
                        </div>
                        <div class="interface-info-filed">
                            <h3>IP:</h3>
                            <div class="interface-ip" id="exit-interface-1-ip"></div>
                        </div>
                    </div>

                </div>
                <div class="interface-queue" id="exit-interface-1-queue">
                </div>
            </div>
            <div class="interface exit-interface">
                <div class="interface-info-container">
                    <div class="interface-info">
                        <div class="interface-info-filed" style="background-color: green;">&nbsp;</div>
                        <div class="interface-info-filed">
                            <h3>Interface:</h3>
                            <div class="interface-id" id="exit-interface-2-name"></div>
                        </div>
                        <div class="interface-info-filed">
                            <h3>IP:</h3>
                            <div class="interface-ip" id="exit-interface-2-ip"></div>
                        </div>
                    </div>

                </div>
                <div class="interface-queue" id="exit-interface-2-queue">
                </div>
            </div>
        </div>
    </main>
    <div class="tables-container">
        <div class="discarded-datagrams-table">
            <h2>Discarded Datagrams</h2>
            <div class="discarded-datagrams">

            </div>
        </div>
        <div class="routing-table-container">
            <h2>Routing Table</h2>
            <div class="routing-table">
                <div class="routing-table-header">
                    <h5>Destination</h5>
                    <h5>Next Hop IP</h5>
                    <h5>Interface</h5>
                </div>
            </div>
        </div>
        <div class="arp-table-container">
            <h2>ARP Table</h2>
            <div class="arp-table">
                <div class="arp-table-header">
                    <h5>IP</h5>
                    <h5>MAC</h5>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    //Вашиот код тука
    //Не заборавајте да ги отстраните hard-code-ираните елементи од страницата


    //Класата со која е преставен еден датаграм
    class Datagram
    {
        //Податочн членки на еден датаграм
        version;
        headerLength;
        totalLength;
        ttl;
        protocol;
        checksum;
        sourceIP;
        destinationIP;
        payload;


        macAddress;

        //Конструкот на класата
        constructor(version, headerLength, totalLength, ttl, protocol, checksum, sourceIP, destinationIP, payload)
        {
            this.version = version;
            this.headerLength = headerLength;
            this.totalLength = totalLength;
            this.ttl = ttl;
            this.protocol = protocol;
            this.checksum = checksum;
            this.sourceIP = sourceIP;
            this.destinationIP = destinationIP;
            this.payload = payload;

            this.macAddress = "";
        }

        //Функција со која се внесува MAC адресата на next-hop интерфејсто
        encapsulate(macAddress)
        {
            this.macAddress = macAddress;
        }

        //Статичка функција со која од даден JSON објект се добива инстанца од класата Datagram
        static getDatagramInstanceFromJson(datagramJson)
        {
            return new Datagram(datagramJson.version,
                datagramJson.headerLength,
                datagramJson.totalLength,
                datagramJson.timeToLive,
                datagramJson.protocol,
                datagramJson.headerChecksum,
                datagramJson.sourceIP,
                datagramJson.destinationIP,
                datagramJson.payload
            )
        }

        //Функција со која се добива потребната HTML структура за еден Datagram објект
        getHTMLFormat()
        {
            return `
            <div class="datagram">
                    <div class="datagram-field">
                        <h4>Version:</h4>
                        <div>${this.version}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Header Length:</h4>
                        <div>${this.headerLength}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Total Length:</h4>
                        <div>${this.totalLength}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Time To Live:</h4>
                        <div>${this.ttl}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Protocol:</h4>
                        <div>${this.protocol}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Checksum:</h4>
                        <div>${this.checksum}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Source IP:</h4>
                        <div>${this.sourceIP}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Destination IP:</h4>
                        <div>${this.destinationIP}</div>
                    </div>
                    <div class="datagram-field">
                        <h4>Payload:</h4>
                        <div>${this.payload}</div>
                    </div>
                </div>

            `
        }

        //Функција со која се добива потребната HTML структура за еден Datagram објект со доболнителни информации за MAC адресата
        getHTMLFormatWithMac()
        {
            return `
             <div class="datagram">
                        <div class="datagram-field">
                            <h4>Version:</h4>
                            <div>${this.version}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Header Length:</h4>
                            <div>${this.headerLength}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Total Length:</h4>
                            <div>${this.totalLength}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Time To Live:</h4>
                            <div>${this.ttl}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Protocol:</h4>
                            <div>${this.protocol}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Checksum:</h4>
                            <div>${this.checksum}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Source IP:</h4>
                            <div>${this.sourceIP}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Destination IP:</h4>
                            <div>${this.destinationIP}</div>
                        </div>
                        <div class="datagram-field">
                            <h4>Payload:</h4>
                            <div>${this.payload}</div>
                        </div>
                        <div class="frame-field">
                            <h4>MAC Address</h4>
                            <div>${this.macAddress}</div>
                        </div>
                    </div>
            `
        }

        //Функција со која се декрементира TTL на датаграм. Функцијата враќа boolean со кој се определува дали датаграмот треба да се отфрли
        //Пр. false => отфрлање, true => рутирање
        decreaseTTLAndCheck()
        {
            this.ttl--;
            return !!this.ttl;
        }
    }

    //Класа во која се групирани UI елементите на апликацијата
    class UI
    {
        discardedDatagramsTable;
        routingTable;
        arpTable;
        enteringInterface;
        exitInterfaces;
        simulateRoutingButton;


        //Конструктор во кој се прави соодветно селектирање на HTML елементите
        constructor()
        {
            this.enteringInterface = document.querySelector(".entering-interface-container .interface");
            this.exitInterfaces = document.querySelectorAll(".exit-interface");

            this.discardedDatagramsTable = document.querySelector(".discarded-datagrams");
            this.routingTable = document.querySelector(".routing-table");
            this.arpTable = document.querySelector(".arp-table");

            this.simulateRoutingButton = document.querySelector("#simulate-routing-btn");
            this.addEventsToSimulateRoutingButton();

        }

        //Функција со која се дефинира што се слчува при клик на копчето „Simulate Routing“
        addEventsToSimulateRoutingButton()
        {
            this.simulateRoutingButton.addEventListener("click", () =>
            {
                router.routeDatagram();
            })
        }
    }

    //Класа со која е претставен еден интерфејс на рутерот
    class RouterInterface
    {
        id;
        ip;
        datagrams;
        htmlElement;

        //Конструктор на класата
        constructor(id, ip, htmlElement)
        {
            this.id = id;
            this.ip = ip;
            this.datagrams = [];
            this.htmlElement = htmlElement;
            this.activeInterface();
        }

        //Функција со која се поставува соодветен датаграм во редот од интерфејсот
        queueUpDatagram(datagram)
        {
            this.datagrams.push(datagram);


            //Визуелно прикажување на датаграмот на страницата
            this.renderDatagrams();
        }

        //Функција со која се отстранува соодветен датаграм од редот на интерфејсот
        removeDatagram()
        {
            this.datagrams.shift();
            this.renderDatagrams();
        }

        //Функција со која даден интерфејс се активира: Му се доделува соодвета IP адреса и соодветен Id
        //Пр. IP:192.162.12.12, ID: FastEthernet0/1
        activeInterface()
        {
            const interfaceIdElement = this.htmlElement.querySelector(".interface-id");
            const interfaceIpElement = this.htmlElement.querySelector(".interface-ip");

            interfaceIdElement.innerHTML = this.id;
            interfaceIpElement.innerHTML = this.ip;
        }

        //Функција со која визуелно на станицата се прикажуваат датаграмите од интерфејсот
        renderDatagrams()
        {
            const queueElement = this.htmlElement.querySelector(".interface-queue");

            queueElement.innerHTML = "";

            //Прикажувањето е според правилот FIFO: прв влезе, прв излезе
            for (let i = this.datagrams.length - 1; i >= 0; i--)
            {
                const datagram = this.datagrams[i];
                queueElement.innerHTML += datagram.getHTMLFormatWithMac();
            }
        }
    }


    //Класата со која е преставен еден рутер со сите негови карактеристики и функции
    class Router
    {
        // Датаграмите коишто се наоѓаат на влезниот интерфејс и треба да се процесираат и рутираат
        datagramsToProcess;

        //Името на рутерот
        hostname;

        //Влезниот интерфејс на рутерот
        enteringInterface;

        //Останатите (излезни) интерфејси на рутерот
        interfaces;

        //Рутирачката табела на рутерот
        routingTable;

        //ARP табелата на рутерот
        arpTable;

        //Отфрлените датаграми
        discardedDatagrams;

        //Конструктор на класата
        constructor()
        {
            this.datagramsToProcess = [];
            this.discardedDatagrams = [];

            this.hostname = "";
            this.enteringInterface = null;
            this.interfaces = {};

            this.routingTable = {};
            this.arpTable = {};
        }

        //Функција со која се конфигурира рутерот според податоците во "router-settings.json" датотеката
        async setupSettings()
        {
            const routerSettings = await fetchData("https://raw.githubusercontent.com/Itonkdong/JSON/main/router-settings.json");

            this.hostname = routerSettings.hostname;
            this.assignIpToInterfaces(routerSettings);
            this.fillTables(routerSettings);
        }

        //Функција со која се прави вчитување и визуелно прикажување на датаграмите од "datagrams.json" датотеката
        async fetchDatagrams()
        {
            const datagramsJson = await fetchData("https://raw.githubusercontent.com/Itonkdong/JSON/main/datagrams.json");

            datagramsJson.forEach(datagramJson =>
            {
                //Секој вчитан датаграм се поставува во редот од влезниот интерфејс
                this.queueUpDatagram(Datagram.getDatagramInstanceFromJson(datagramJson));
            })
        }


        //Функција со која даден датаграм се сместува во редот од влезниот интерфејс
        queueUpDatagram(datagram)
        {
            this.datagramsToProcess.push(datagram);
            this.enteringInterface.queueUpDatagram(datagram);
        }

        //Главната функција со која се прави рутирање на датаграмот што се наоѓа на врвот од редот на влезниот интерфејс
        routeDatagram()
        {
            //Соодветна валидација
            if (!this.datagramsToProcess.length) return;

            //Датаграмот на врвот од редот на влезниот интерфејс
            const datagram = this.datagramsToProcess.shift();

            //Проверка дали датаграмот треба да се отфрлил
            if (!datagram.decreaseTTLAndCheck())
            {
                //Доколку датаграмот треба да се отфли, тој се отстранува од влезниот интерфејс
                this.enteringInterface.removeDatagram();

                //Датаграмот се поставува во табот-"Discarded Datagrams"
                this.discardDatagram(datagram);
                return;
            }

            //Податоци потребни за рутирање на датаграмот
            const destinationIP = datagram.destinationIP;
            const nextHop = this.routingTable[destinationIP].nextHop;
            const interfaceId = this.routingTable[destinationIP].interfaceId;
            const macAddress = this.arpTable[nextHop];

            //Доделување на соодветната MAC адреса
            datagram.encapsulate(macAddress);

            //Интерфејсот од рутерот во чии ред треба да се постави датаграмот
            const routerInterface = this.interfaces[interfaceId];

            //Постаување на датаграмот во редот од соодветниот интерфејс
            routerInterface.queueUpDatagram(datagram);

            //Отстранување на датаграмот од влезниот интерфејс
            this.enteringInterface.removeDatagram();
        }

        //Функција со која даден датаграм се отфрла - се поставува во таб-от "Discarded Datagrams"
        discardDatagram(datagram)
        {
            this.discardedDatagrams.push(datagram);
            ui.discardedDatagramsTable.innerHTML += datagram.getHTMLFormat();
        }

        //Функција со која се доделуваат IP адреси на интерфејсите од рутерот
        // според податоците во "router-settings.json"
        assignIpToInterfaces(routerSettings)
        {
            this.enteringInterface = new RouterInterface(
                routerSettings.enteringInterface.id,
                routerSettings.enteringInterface.ip,
                ui.enteringInterface
            )

            let index = 0;
            for (const interfaceId in routerSettings.interfaces)
            {
                this.interfaces[interfaceId] = new RouterInterface(
                    interfaceId,
                    routerSettings.interfaces[interfaceId],
                    ui.exitInterfaces[index]
                );
                index++;
            }
        }

        //Функција со која се прави логичко и визуелно пополнување
        // на рутирачката и arp табелата на рутерот според податоците во "router-settings.json"
        fillTables(routerSettings)
        {
            for (const ipAddress in routerSettings.routingTable)
            {
                const nextHop = routerSettings.routingTable[ipAddress].nextHop;
                const interfaceId = routerSettings.routingTable[ipAddress].interface;
                this.routingTable[ipAddress] = {
                    nextHop: nextHop,
                    interfaceId: interfaceId
                }
                ui.routingTable.innerHTML += `<div class="routing-table-entry">
                    <div>${ipAddress}</div>
                    <div>${nextHop}</div>
                    <div>${interfaceId}</div>
                </div>`
            }

            for (const ipAddress in routerSettings.arpTable)
            {
                const macAddress = routerSettings.arpTable[ipAddress];
                this.arpTable[ipAddress] = macAddress;

                ui.arpTable.innerHTML += `
                <div class="arp-table-entry">
                    <div>${ipAddress}</div>
                    <div>${macAddress}</div>
                </div>
                `
            }
        }
    }


    // Оваа асинхрона функција ги вчитува податоците од специфицираната патека користејќи го Fetch API-то.
    async function fetchData(pth)
    {
        try
        {
            // Обид да се вчитаат податоците од специфицираната патека.
            const promise = await fetch(pth);
            // Откако promise-от се исполни (resolve), парсирај го одговорот како JSON и врати го.
            return promise.json();
        } catch (e)
        {
            // Ако се појави грешка за време на вчитувањето или парсирањето, логирај ја гршката во конзолата.
            console.error("Error:", e);
        }
    }

    //Креирање на инстанци од соодветните класи
    const ui = new UI();
    const router = new Router();

    //Повик на соотвените функции
    router.setupSettings();
    router.fetchDatagrams();
</script>
</body>
</html>